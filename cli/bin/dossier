#!/usr/bin/env node

/**
 * Dossier CLI - Main entry point
 * Multi-command CLI for creating, verifying, and executing dossiers
 */

const { program } = require('commander');
const { execSync } = require('child_process');
const path = require('path');

// Package info
const pkg = require('../package.json');

// ============================================================================
// SHARED: Multi-Stage Verification Function
// ============================================================================
async function runVerification(file, options) {
  const verifyScript = path.join(__dirname, 'dossier-verify');
  const results = { passed: true, stages: [] };

  console.log('üîê Running Multi-Stage Verification Pipeline...\n');

  // Stage 1: Integrity Check (checksum + signature)
  if (!options.skipChecksum && !options.skipAllChecks) {
    console.log('üìä Stage 1: Integrity Check (checksum + signature)');
    try {
      execSync(`node "${verifyScript}" "${file}" --exit-code-only 2>/dev/null`, { stdio: 'pipe' });
      console.log('   ‚úÖ PASSED: Checksum and signature valid\n');
      results.stages.push({ stage: 1, name: 'Integrity', passed: true });
    } catch (error) {
      console.log('   ‚ùå FAILED: Verification failed');
      console.log('   Run "dossier verify ' + file + '" for details\n');
      results.passed = false;
      results.stages.push({ stage: 1, name: 'Integrity', passed: false });
      return results;
    }
  } else {
    console.log('‚ö†Ô∏è  Stage 1: SKIPPED - Integrity check\n');
    results.stages.push({ stage: 1, name: 'Integrity', skipped: true });
  }

  // Stage 2: Author Whitelist/Blacklist (TBD - demo)
  if (!options.skipAuthorCheck && !options.skipAllChecks) {
    console.log('üë§ Stage 2: Author Whitelist/Blacklist');
    console.log('   ‚úÖ PASSED: Author check (not in blacklist)');
    console.log('   üìã [Demo: Would check ~/.dossier/authors-whitelist.txt]');
    console.log('   üìã [Demo: Would check ~/.dossier/authors-blacklist.txt]\n');
    results.stages.push({ stage: 2, name: 'Author Check', passed: true, demo: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 2: SKIPPED - Author check\n');
    results.stages.push({ stage: 2, name: 'Author Check', skipped: true });
  }

  // Stage 3: Dossier Whitelist/Blacklist (TBD - demo)
  if (!options.skipDossierCheck && !options.skipAllChecks) {
    console.log('üìã Stage 3: Dossier Whitelist/Blacklist');
    console.log('   ‚úÖ PASSED: Dossier check (not in blacklist)');
    console.log('   üìã [Demo: Would check ~/.dossier/dossiers-whitelist.txt]');
    console.log('   üìã [Demo: Would check ~/.dossier/dossiers-blacklist.txt]\n');
    results.stages.push({ stage: 3, name: 'Dossier Check', passed: true, demo: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 3: SKIPPED - Dossier check\n');
    results.stages.push({ stage: 3, name: 'Dossier Check', skipped: true });
  }

  // Stage 4: Risk Assessment
  if (!options.skipRiskAssessment && !options.skipAllChecks) {
    console.log('üî¥ Stage 4: Risk Assessment');
    console.log('   ‚úÖ PASSED: Risk level acceptable');
    console.log('   üìä Risk: MEDIUM (based on verification)\n');
    if (!options.force && !options.noPrompt) {
      console.log('   ‚ÑπÔ∏è  High-risk dossiers would prompt for confirmation here');
    }
    results.stages.push({ stage: 4, name: 'Risk Assessment', passed: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 4: SKIPPED - Risk assessment\n');
    results.stages.push({ stage: 4, name: 'Risk Assessment', skipped: true });
  }

  // Stage 5: Review Dossier (TBD - demo)
  if (!options.skipReview && !options.skipAllChecks) {
    const reviewDossierPath = options.reviewDossier || 'built-in://review-dossier.ds.md';
    console.log('üîç Stage 5: Review Dossier Analysis');
    console.log(`   Using: ${reviewDossierPath}`);
    console.log('   ‚úÖ PASSED: Review dossier approved');
    console.log('   üìã [Demo: Would execute review dossier to analyze target]');
    console.log('   üìã [Demo: Review dossier would check for dangerous patterns]\n');
    results.stages.push({ stage: 5, name: 'Review Dossier', passed: true, demo: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 5: SKIPPED - Review dossier\n');
    results.stages.push({ stage: 5, name: 'Review Dossier', skipped: true });
  }

  return results;
}

// Setup program
program
  .name('dossier')
  .description('CLI tool for creating, verifying, and executing dossiers')
  .version(pkg.version);

// ============================================================================
// COMMAND: verify (IMPLEMENTED)
// ============================================================================
program
  .command('verify')
  .description('Verify dossier integrity and authenticity')
  .argument('<file>', 'Dossier file or URL to verify')
  .option('--verbose', 'Show detailed verification output')
  .option('--skip-checksum', 'Skip checksum verification (DANGEROUS)')
  .option('--skip-signature', 'Skip signature verification')
  .option('--skip-author-check', 'Skip author whitelist/blacklist')
  .option('--skip-dossier-check', 'Skip dossier whitelist/blacklist')
  .option('--skip-risk-assessment', 'Skip risk level checks')
  .option('--skip-review', 'Skip review dossier execution')
  .option('--skip-all-checks', 'Skip ALL verifications (VERY DANGEROUS)')
  .option('--review-dossier <file>', 'Custom review dossier')
  .action(async (file, options) => {
    // Use shared verification function
    const result = await runVerification(file, options);

    if (!result.passed) {
      console.log('‚ùå Verification failed\n');
      process.exit(1);
    }

    // Show detailed output if requested
    if (options.verbose) {
      console.log('‚úÖ All verification stages passed\n');
      console.log('Stages completed:');
      result.stages.forEach(s => {
        const status = s.passed ? '‚úÖ' : s.skipped ? '‚ö†Ô∏è' : '‚ùå';
        const demo = s.demo ? ' (demo)' : '';
        console.log(`  ${status} Stage ${s.stage}: ${s.name}${demo}`);
      });
    } else {
      console.log('‚úÖ Verification passed\n');
      console.log('Run with --verbose for detailed stage information');
    }

    process.exit(0);
  });

// ============================================================================
// COMMAND: run (IMPLEMENTED)
// ============================================================================
program
  .command('run')
  .description('Verify, audit, and execute dossier')
  .argument('<file>', 'Dossier file or URL to run')
  .option('--llm <name>', 'LLM to use (claude-code, cursor, auto)', 'auto')
  .option('--dry-run', 'Show plan without executing')
  .option('--force', 'Skip risk warnings')
  .option('--no-prompt', 'Don\'t ask for confirmation')
  .option('--skip-checksum', 'Skip checksum verification (DANGEROUS)')
  .option('--skip-signature', 'Skip signature verification')
  .option('--skip-author-check', 'Skip author whitelist/blacklist')
  .option('--skip-dossier-check', 'Skip dossier whitelist/blacklist')
  .option('--skip-risk-assessment', 'Skip risk level checks')
  .option('--skip-review', 'Skip review dossier execution')
  .option('--skip-all-checks', 'Skip ALL verifications (VERY DANGEROUS)')
  .option('--review-dossier <file>', 'Custom review dossier')
  .option('--review-llm <name>', 'LLM for review step')
  .action(async (file, options) => {
    // Use shared verification function
    const result = await runVerification(file, options);

    if (!result.passed) {
      console.log('‚ùå Verification failed - cannot execute\n');
      process.exit(1);
    }

    // Audit Log (console output for MVP)
    console.log('üìù Audit Log:');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`   Timestamp:   ${new Date().toISOString()}`);
    console.log(`   Dossier:     ${file}`);
    console.log(`   User:        ${process.env.USER}@${require('os').hostname()}`);
    console.log(`   LLM:         ${options.llm}`);
    console.log(`   Action:      RUN`);
    console.log('   Status:      VERIFIED');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
    console.log('üìã [MVP: Audit log printed to console]');
    console.log('üìã [Future: Would send to audit server]\n');

    // Dry run mode
    if (options.dryRun) {
      console.log('üß™ DRY RUN MODE - No execution\n');
      console.log('Would execute:');
      console.log(`   File: ${file}`);
      console.log(`   LLM: ${options.llm}`);

      // Detect LLM for dry run display
      let llmCommand = 'auto-detect';
      try {
        execSync('command -v claude-code', { stdio: 'pipe' });
        llmCommand = `claude-code "Execute the verified dossier at ${file}"`;
      } catch {
        try {
          execSync('command -v cursor', { stdio: 'pipe' });
          llmCommand = `cursor "${file}"`;
        } catch {
          llmCommand = 'No LLM detected - would show error';
        }
      }

      console.log(`   Command: ${llmCommand}\n`);
      console.log('‚úÖ All verifications passed - ready to execute');
      process.exit(0);
    }

    // LLM Detection and Execution
    console.log('ü§ñ Executing Dossier...\n');

    let llmToUse = options.llm;
    if (options.llm === 'auto') {
      // Auto-detect LLM
      try {
        execSync('command -v claude-code', { stdio: 'pipe' });
        llmToUse = 'claude-code';
        console.log('   Detected: Claude Code');
      } catch {
        try {
          execSync('command -v cursor', { stdio: 'pipe' });
          llmToUse = 'cursor';
          console.log('   Detected: Cursor');
        } catch {
          console.log('‚ùå No supported LLM detected\n');
          console.log('Supported LLMs:');
          console.log('  - Claude Code (install from https://claude.com/claude-code)');
          console.log('  - Cursor (install from https://cursor.sh)\n');
          console.log('Or specify manually: --llm claude-code\n');
          process.exit(2);
        }
      }
    }

    // Execute via LLM
    try {
      let command;
      if (llmToUse === 'claude-code') {
        command = `claude-code "Execute the verified dossier at ${file}"`;
      } else if (llmToUse === 'cursor') {
        command = `cursor "${file}"`;
      } else {
        console.log(`‚ùå Unknown LLM: ${llmToUse}\n`);
        console.log('Supported: claude-code, cursor, auto\n');
        process.exit(2);
      }

      console.log(`   Executing: ${command}\n`);
      execSync(command, { stdio: 'inherit' });
      console.log('\n‚úÖ Execution completed');
    } catch (error) {
      console.log('\n‚ùå Execution failed');
      process.exit(error.status || 2);
    }
  });

// ============================================================================
// COMMAND: create (TBD)
// ============================================================================
program
  .command('create')
  .description('Create new dossier [TBD]')
  .argument('[file]', 'Output file path')
  .option('--template <name>', 'Use template (basic, devops, data-science)')
  .option('--interactive', 'Guided creation with prompts')
  .option('--title <title>', 'Dossier title')
  .option('--risk <level>', 'Risk level (low, medium, high, critical)')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  create tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: list (TBD)
// ============================================================================
program
  .command('list')
  .description('List available dossiers [TBD]')
  .argument('[directory]', 'Directory to search', '.')
  .option('--recursive', 'Search subdirectories')
  .option('--verified-only', 'Only show verified dossiers')
  .option('--risk <level>', 'Filter by risk level')
  .option('--format <fmt>', 'Output format (table, json, simple)', 'table')
  .action((directory, options) => {
    console.log('‚ö†Ô∏è  list tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: sign (TBD)
// ============================================================================
program
  .command('sign')
  .description('Sign dossier with cryptographic key [TBD]')
  .argument('<file>', 'Dossier file to sign')
  .option('--key <path>', 'Path to signing key')
  .option('--method <type>', 'Signing method (minisign, kms)', 'minisign')
  .option('--output <file>', 'Output signed dossier')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  sign tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: publish (TBD)
// ============================================================================
program
  .command('publish')
  .description('Share dossier to registry [TBD]')
  .argument('<file>', 'Dossier file to publish')
  .option('--registry <url>', 'Registry URL')
  .option('--name <name>', 'Custom name in registry')
  .option('--tags <tags>', 'Comma-separated tags')
  .option('--private', 'Private publication')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  publish tbd - follow docs/planning/cli-evolution.md');
    console.log('');
    console.log('MVP simulation would show:');
    console.log('Registry ID:  dsr-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx');
    console.log('Public URL:   https://registry.dossier.ai/dsr-xxxxxxxx');
    console.log('Install:      dossier run dsr-xxxxxxxx');
    process.exit(1);
  });

// ============================================================================
// COMMAND: checksum (TBD)
// ============================================================================
program
  .command('checksum')
  .description('Calculate and update dossier checksum [TBD]')
  .argument('<file>', 'Dossier file')
  .option('--update', 'Update checksum in file')
  .option('--verify', 'Just verify, don\'t update')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  checksum tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: validate (TBD)
// ============================================================================
program
  .command('validate')
  .description('Validate dossier against schema [TBD]')
  .argument('<file>', 'Dossier file to validate')
  .option('--schema <file>', 'Custom schema file')
  .option('--fix', 'Auto-fix issues')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  validate tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: init (TBD)
// ============================================================================
program
  .command('init')
  .description('Initialize new dossier project [TBD]')
  .argument('[name]', 'Project name')
  .option('--template <name>', 'Project template')
  .option('--git', 'Initialize git repository')
  .action((name, options) => {
    console.log('‚ö†Ô∏è  init tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: info (TBD)
// ============================================================================
program
  .command('info')
  .description('Show dossier metadata [TBD]')
  .argument('<file>', 'Dossier file or URL')
  .option('--json', 'JSON output')
  .option('--short', 'Brief summary only')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  info tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// Parse and execute
// ============================================================================
program.parse(process.argv);

// Show help if no command provided
if (!process.argv.slice(2).length) {
  program.outputHelp();
}
