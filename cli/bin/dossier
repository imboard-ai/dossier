#!/usr/bin/env node

/**
 * Dossier CLI - Main entry point
 * Multi-command CLI for creating, verifying, and executing dossiers
 */

const { program } = require('commander');
const { execSync } = require('child_process');
const path = require('path');
const config = require('../lib/config');

// Package info
const pkg = require('../package.json');

// ============================================================================
// SHARED: LLM Detection and Command Building
// ============================================================================

/**
 * Detect and resolve which LLM to use
 * @param {string} llmOption - The LLM option (from CLI or config)
 * @param {boolean} silent - Whether to suppress console output
 * @returns {string} The resolved LLM name
 */
function detectLlm(llmOption, silent = false) {
  if (llmOption !== 'auto') {
    return llmOption;
  }

  // Auto-detect LLM
  try {
    execSync('command -v claude-code', { stdio: 'pipe' });
    if (!silent) console.log('   Detected: Claude Code');
    return 'claude-code';
  } catch {
    try {
      execSync('command -v cursor', { stdio: 'pipe' });
      if (!silent) console.log('   Detected: Cursor');
      return 'cursor';
    } catch {
      if (!silent) {
        console.log('‚ùå No supported LLM detected\n');
        console.log('Supported LLMs:');
        console.log('  - Claude Code (install from https://claude.com/claude-code)');
        console.log('  - Cursor (install from https://cursor.sh)\n');
        console.log('Or specify manually: --llm claude-code\n');
      }
      return null;
    }
  }
}

/**
 * Build the execution command for a given LLM
 * @param {string} llm - The LLM to use
 * @param {string} file - The dossier file/URL
 * @returns {string} The command to execute
 */
function buildLlmCommand(llm, file) {
  // Detect if file is a URL
  const isUrl = file.startsWith('http://') || file.startsWith('https://');

  if (llm === 'claude-code') {
    // Use headless mode (-p) to execute non-interactively and print output to stdout
    if (isUrl) {
      // For URLs: Download to temp file, execute, cleanup
      return `tmpfile=$(mktemp /tmp/dossier.XXXXXX.ds.md) && curl -sL "${file}" -o "\${tmpfile}" && test -s "\${tmpfile}" && cat "\${tmpfile}" | claude -p; status=$?; rm -f "\${tmpfile}"; exit $status`;
    } else {
      // For local files: Read directly
      return `cat "${file}" | claude -p`;
    }
  } else if (llm === 'cursor') {
    return `cursor "${file}"`;
  } else {
    return null;
  }
}

// ============================================================================
// SHARED: Multi-Stage Verification Function
// ============================================================================
async function runVerification(file, options) {
  const verifyScript = path.join(__dirname, 'dossier-verify');
  const results = { passed: true, stages: [] };

  console.log('üîê Running Multi-Stage Verification Pipeline...\n');

  // Stage 1: Integrity Check (checksum + signature)
  if (!options.skipChecksum && !options.skipAllChecks) {
    console.log('üìä Stage 1: Integrity Check (checksum + signature)');
    try {
      execSync(`node "${verifyScript}" "${file}" --exit-code-only 2>/dev/null`, { stdio: 'pipe' });
      console.log('   ‚úÖ PASSED: Checksum and signature valid\n');
      results.stages.push({ stage: 1, name: 'Integrity', passed: true });
    } catch (error) {
      console.log('   ‚ùå FAILED: Verification failed');
      console.log('   Run "dossier verify ' + file + '" for details\n');
      results.passed = false;
      results.stages.push({ stage: 1, name: 'Integrity', passed: false });
      return results;
    }
  } else {
    console.log('‚ö†Ô∏è  Stage 1: SKIPPED - Integrity check\n');
    results.stages.push({ stage: 1, name: 'Integrity', skipped: true });
  }

  // Stage 2: Author Whitelist/Blacklist (TBD - demo)
  if (!options.skipAuthorCheck && !options.skipAllChecks) {
    console.log('üë§ Stage 2: Author Whitelist/Blacklist');
    console.log('   ‚úÖ PASSED: Author check (not in blacklist)');
    console.log('   üìã [Demo: Would check ~/.dossier/authors-whitelist.txt]');
    console.log('   üìã [Demo: Would check ~/.dossier/authors-blacklist.txt]\n');
    results.stages.push({ stage: 2, name: 'Author Check', passed: true, demo: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 2: SKIPPED - Author check\n');
    results.stages.push({ stage: 2, name: 'Author Check', skipped: true });
  }

  // Stage 3: Dossier Whitelist/Blacklist (TBD - demo)
  if (!options.skipDossierCheck && !options.skipAllChecks) {
    console.log('üìã Stage 3: Dossier Whitelist/Blacklist');
    console.log('   ‚úÖ PASSED: Dossier check (not in blacklist)');
    console.log('   üìã [Demo: Would check ~/.dossier/dossiers-whitelist.txt]');
    console.log('   üìã [Demo: Would check ~/.dossier/dossiers-blacklist.txt]\n');
    results.stages.push({ stage: 3, name: 'Dossier Check', passed: true, demo: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 3: SKIPPED - Dossier check\n');
    results.stages.push({ stage: 3, name: 'Dossier Check', skipped: true });
  }

  // Stage 4: Risk Assessment
  if (!options.skipRiskAssessment && !options.skipAllChecks) {
    console.log('üî¥ Stage 4: Risk Assessment');
    console.log('   ‚úÖ PASSED: Risk level acceptable');
    console.log('   üìä Risk: MEDIUM (based on verification)\n');
    if (!options.force && !options.noPrompt) {
      console.log('   ‚ÑπÔ∏è  High-risk dossiers would prompt for confirmation here');
    }
    results.stages.push({ stage: 4, name: 'Risk Assessment', passed: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 4: SKIPPED - Risk assessment\n');
    results.stages.push({ stage: 4, name: 'Risk Assessment', skipped: true });
  }

  // Stage 5: Review Dossier (TBD - demo)
  if (!options.skipReview && !options.skipAllChecks) {
    const reviewDossierPath = options.reviewDossier || 'built-in://review-dossier.ds.md';
    console.log('üîç Stage 5: Review Dossier Analysis');
    console.log(`   Using: ${reviewDossierPath}`);
    console.log('   ‚úÖ PASSED: Review dossier approved');
    console.log('   üìã [Demo: Would execute review dossier to analyze target]');
    console.log('   üìã [Demo: Review dossier would check for dangerous patterns]\n');
    results.stages.push({ stage: 5, name: 'Review Dossier', passed: true, demo: true });
  } else {
    console.log('‚ö†Ô∏è  Stage 5: SKIPPED - Review dossier\n');
    results.stages.push({ stage: 5, name: 'Review Dossier', skipped: true });
  }

  return results;
}

// Setup program
program
  .name('dossier')
  .description('CLI tool for creating, verifying, and executing dossiers')
  .version(pkg.version);

// ============================================================================
// COMMAND: verify (IMPLEMENTED)
// ============================================================================
program
  .command('verify')
  .description('Verify dossier integrity and authenticity')
  .argument('<file>', 'Dossier file or URL to verify')
  .option('--verbose', 'Show detailed verification output')
  .option('--skip-checksum', 'Skip checksum verification (DANGEROUS)')
  .option('--skip-signature', 'Skip signature verification')
  .option('--skip-author-check', 'Skip author whitelist/blacklist')
  .option('--skip-dossier-check', 'Skip dossier whitelist/blacklist')
  .option('--skip-risk-assessment', 'Skip risk level checks')
  .option('--skip-review', 'Skip review dossier execution')
  .option('--skip-all-checks', 'Skip ALL verifications (VERY DANGEROUS)')
  .option('--review-dossier <file>', 'Custom review dossier')
  .action(async (file, options) => {
    // Use shared verification function
    const result = await runVerification(file, options);

    if (!result.passed) {
      console.log('‚ùå Verification failed\n');
      process.exit(1);
    }

    // Show detailed output if requested
    if (options.verbose) {
      console.log('‚úÖ All verification stages passed\n');
      console.log('Stages completed:');
      result.stages.forEach(s => {
        const status = s.passed ? '‚úÖ' : s.skipped ? '‚ö†Ô∏è' : '‚ùå';
        const demo = s.demo ? ' (demo)' : '';
        console.log(`  ${status} Stage ${s.stage}: ${s.name}${demo}`);
      });
    } else {
      console.log('‚úÖ Verification passed\n');
      console.log('Run with --verbose for detailed stage information');
    }

    process.exit(0);
  });

// ============================================================================
// COMMAND: run (IMPLEMENTED)
// ============================================================================
program
  .command('run')
  .description('Verify, audit, and execute dossier')
  .argument('<file>', 'Dossier file or URL to run')
  .option('--llm <name>', 'LLM to use (claude-code, cursor, auto)')
  .option('--dry-run', 'Show plan without executing')
  .option('--force', 'Skip risk warnings')
  .option('--no-prompt', 'Don\'t ask for confirmation')
  .option('--skip-checksum', 'Skip checksum verification (DANGEROUS)')
  .option('--skip-signature', 'Skip signature verification')
  .option('--skip-author-check', 'Skip author whitelist/blacklist')
  .option('--skip-dossier-check', 'Skip dossier whitelist/blacklist')
  .option('--skip-risk-assessment', 'Skip risk level checks')
  .option('--skip-review', 'Skip review dossier execution')
  .option('--skip-all-checks', 'Skip ALL verifications (VERY DANGEROUS)')
  .option('--review-dossier <file>', 'Custom review dossier')
  .option('--review-llm <name>', 'LLM for review step')
  .action(async (file, options) => {
    // Use shared verification function
    const result = await runVerification(file, options);

    if (!result.passed) {
      console.log('‚ùå Verification failed - cannot execute\n');
      process.exit(1);
    }

    // Determine LLM to use (CLI option > config > auto)
    const llmOption = options.llm || config.getConfig('defaultLlm') || 'auto';

    // Audit Log (console output for MVP)
    console.log('üìù Audit Log:');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`   Timestamp:   ${new Date().toISOString()}`);
    console.log(`   Dossier:     ${file}`);
    console.log(`   User:        ${process.env.USER}@${require('os').hostname()}`);
    console.log(`   LLM:         ${llmOption}`);
    console.log(`   Action:      RUN`);
    console.log('   Status:      VERIFIED');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
    console.log('üìã [MVP: Audit log printed to console]');
    console.log('üìã [Future: Would send to audit server]\n');

    // Dry run mode
    if (options.dryRun) {
      console.log('üß™ DRY RUN MODE - No execution\n');
      console.log('Would execute:');
      console.log(`   File: ${file}`);
      console.log(`   LLM: ${llmOption}`);

      // Detect LLM and build command
      const llmToUse = detectLlm(llmOption, true);
      const command = llmToUse ? buildLlmCommand(llmToUse, file) : 'No LLM detected - would show error';

      console.log(`   Command: ${command}\n`);
      console.log('‚úÖ All verifications passed - ready to execute');
      process.exit(0);
    }

    // LLM Detection and Execution
    console.log('ü§ñ Executing Dossier...\n');

    const llmToUse = detectLlm(llmOption);
    if (!llmToUse) {
      process.exit(2);
    }

    // Build and execute command
    const command = buildLlmCommand(llmToUse, file);
    if (!command) {
      console.log(`‚ùå Unknown LLM: ${llmToUse}\n`);
      console.log('Supported: claude-code, cursor, auto\n');
      process.exit(2);
    }

    try {
      console.log(`   Executing: ${command}\n`);
      execSync(command, { stdio: 'inherit' });
      console.log('\n‚úÖ Execution completed');
    } catch (error) {
      console.log('\n‚ùå Execution failed');
      process.exit(error.status || 2);
    }
  });

// ============================================================================
// COMMAND: config (IMPLEMENTED)
// ============================================================================
program
  .command('config')
  .description('Manage dossier configuration')
  .argument('[key]', 'Configuration key (e.g., defaultLlm)')
  .argument('[value]', 'Value to set (omit to get current value)')
  .option('--list', 'List all configuration')
  .option('--reset', 'Reset to defaults')
  .action((key, value, options) => {
    // List all config
    if (options.list || (!key && !options.reset)) {
      const currentConfig = config.loadConfig();
      console.log('üìã Current Configuration:\n');
      console.log(`   Config file: ${config.CONFIG_FILE}\n`);
      Object.entries(currentConfig).forEach(([k, v]) => {
        console.log(`   ${k}: ${v}`);
      });
      console.log('\nTo change a setting: dossier config <key> <value>');
      console.log('Example: dossier config defaultLlm claude-code\n');
      process.exit(0);
    }

    // Reset config
    if (options.reset) {
      if (config.saveConfig(config.DEFAULT_CONFIG)) {
        console.log('‚úÖ Configuration reset to defaults\n');
        Object.entries(config.DEFAULT_CONFIG).forEach(([k, v]) => {
          console.log(`   ${k}: ${v}`);
        });
      } else {
        console.log('‚ùå Failed to reset configuration');
        process.exit(1);
      }
      process.exit(0);
    }

    // Get single value
    if (key && !value) {
      const val = config.getConfig(key);
      if (val !== undefined) {
        console.log(`${key}: ${val}`);
      } else {
        console.log(`‚ùå Unknown configuration key: ${key}\n`);
        console.log('Available keys:');
        Object.keys(config.DEFAULT_CONFIG).forEach(k => console.log(`   - ${k}`));
        process.exit(1);
      }
      process.exit(0);
    }

    // Set value
    if (key && value) {
      // Validate known keys
      if (!(key in config.DEFAULT_CONFIG)) {
        console.log(`‚ö†Ô∏è  Warning: '${key}' is not a standard config key\n`);
        console.log('Standard keys:');
        Object.keys(config.DEFAULT_CONFIG).forEach(k => console.log(`   - ${k}`));
        console.log('\nContinuing anyway...\n');
      }

      // Validate defaultLlm values
      if (key === 'defaultLlm') {
        const validLlms = ['auto', 'claude-code', 'cursor'];
        if (!validLlms.includes(value)) {
          console.log(`‚ö†Ô∏è  Warning: '${value}' may not be a supported LLM\n`);
          console.log('Supported values:');
          validLlms.forEach(llm => console.log(`   - ${llm}`));
          console.log('\nContinuing anyway...\n');
        }
      }

      if (config.setConfig(key, value)) {
        console.log(`‚úÖ Configuration updated: ${key} = ${value}`);
      } else {
        console.log('‚ùå Failed to update configuration');
        process.exit(1);
      }
      process.exit(0);
    }
  });

// ============================================================================
// COMMAND: create (TBD)
// ============================================================================
program
  .command('create')
  .description('Create new dossier [TBD]')
  .argument('[file]', 'Output file path')
  .option('--template <name>', 'Use template (basic, devops, data-science)')
  .option('--interactive', 'Guided creation with prompts')
  .option('--title <title>', 'Dossier title')
  .option('--risk <level>', 'Risk level (low, medium, high, critical)')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  create tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: list (TBD)
// ============================================================================
program
  .command('list')
  .description('List available dossiers [TBD]')
  .argument('[directory]', 'Directory to search', '.')
  .option('--recursive', 'Search subdirectories')
  .option('--verified-only', 'Only show verified dossiers')
  .option('--risk <level>', 'Filter by risk level')
  .option('--format <fmt>', 'Output format (table, json, simple)', 'table')
  .action((directory, options) => {
    console.log('‚ö†Ô∏è  list tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: sign (TBD)
// ============================================================================
program
  .command('sign')
  .description('Sign dossier with cryptographic key [TBD]')
  .argument('<file>', 'Dossier file to sign')
  .option('--key <path>', 'Path to signing key')
  .option('--method <type>', 'Signing method (minisign, kms)', 'minisign')
  .option('--output <file>', 'Output signed dossier')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  sign tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: publish (TBD)
// ============================================================================
program
  .command('publish')
  .description('Share dossier to registry [TBD]')
  .argument('<file>', 'Dossier file to publish')
  .option('--registry <url>', 'Registry URL')
  .option('--name <name>', 'Custom name in registry')
  .option('--tags <tags>', 'Comma-separated tags')
  .option('--private', 'Private publication')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  publish tbd - follow docs/planning/cli-evolution.md');
    console.log('');
    console.log('MVP simulation would show:');
    console.log('Registry ID:  dsr-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx');
    console.log('Public URL:   https://registry.dossier.ai/dsr-xxxxxxxx');
    console.log('Install:      dossier run dsr-xxxxxxxx');
    process.exit(1);
  });

// ============================================================================
// COMMAND: checksum (TBD)
// ============================================================================
program
  .command('checksum')
  .description('Calculate and update dossier checksum [TBD]')
  .argument('<file>', 'Dossier file')
  .option('--update', 'Update checksum in file')
  .option('--verify', 'Just verify, don\'t update')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  checksum tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: validate (TBD)
// ============================================================================
program
  .command('validate')
  .description('Validate dossier against schema [TBD]')
  .argument('<file>', 'Dossier file to validate')
  .option('--schema <file>', 'Custom schema file')
  .option('--fix', 'Auto-fix issues')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  validate tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: init (TBD)
// ============================================================================
program
  .command('init')
  .description('Initialize new dossier project [TBD]')
  .argument('[name]', 'Project name')
  .option('--template <name>', 'Project template')
  .option('--git', 'Initialize git repository')
  .action((name, options) => {
    console.log('‚ö†Ô∏è  init tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: info (TBD)
// ============================================================================
program
  .command('info')
  .description('Show dossier metadata [TBD]')
  .argument('<file>', 'Dossier file or URL')
  .option('--json', 'JSON output')
  .option('--short', 'Brief summary only')
  .action((file, options) => {
    console.log('‚ö†Ô∏è  info tbd - follow docs/planning/cli-evolution.md');
    process.exit(1);
  });

// ============================================================================
// COMMAND: keys (IMPLEMENTED)
// ============================================================================
const keysCmd = program
  .command('keys')
  .description('Manage trusted signing keys');

// keys list
keysCmd
  .command('list')
  .description('List trusted signing keys')
  .option('--json', 'JSON output')
  .action((options) => {
    const fs = require('fs');
    const os = require('os');
    const path = require('path');

    const trustedKeysPath = path.join(os.homedir(), '.dossier', 'trusted-keys.txt');

    console.log('\nüîë Trusted Signing Keys\n');

    if (!fs.existsSync(trustedKeysPath)) {
      console.log('‚ö†Ô∏è  No trusted keys file found');
      console.log(`   Location: ${trustedKeysPath}`);
      console.log('\nTo add a trusted key:');
      console.log('   dossier keys add <public-key> <identifier>\n');
      process.exit(0);
    }

    const content = fs.readFileSync(trustedKeysPath, 'utf8');
    const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));

    if (lines.length === 0) {
      console.log('‚ö†Ô∏è  No trusted keys configured');
      console.log(`   File exists at: ${trustedKeysPath}`);
      console.log('\nTo add a trusted key:');
      console.log('   dossier keys add <public-key> <identifier>\n');
      process.exit(0);
    }

    if (options.json) {
      const keys = lines.map(line => {
        const [key, ...idParts] = line.trim().split(/\s+/);
        return { public_key: key, identifier: idParts.join(' ') };
      });
      console.log(JSON.stringify(keys, null, 2));
    } else {
      console.log(`Total: ${lines.length} trusted key(s)\n`);
      lines.forEach((line, index) => {
        const [key, ...idParts] = line.trim().split(/\s+/);
        const identifier = idParts.join(' ');
        const shortKey = key.length > 60 ? key.substring(0, 60) + '...' : key;
        console.log(`${index + 1}. ${identifier}`);
        console.log(`   ${shortKey}`);
        console.log();
      });
      console.log(`Location: ${trustedKeysPath}\n`);
    }

    process.exit(0);
  });

// keys add
keysCmd
  .command('add')
  .description('Add a trusted signing key')
  .argument('<public-key>', 'Public key (base64 or minisign format)')
  .argument('<identifier>', 'Human-readable identifier (e.g., "dossier-team-2025")')
  .action((publicKey, identifier) => {
    const fs = require('fs');
    const os = require('os');
    const path = require('path');

    const dossierDir = path.join(os.homedir(), '.dossier');
    const trustedKeysPath = path.join(dossierDir, 'trusted-keys.txt');

    console.log('\nüîë Adding Trusted Key\n');

    // Create .dossier directory if it doesn't exist
    if (!fs.existsSync(dossierDir)) {
      fs.mkdirSync(dossierDir, { recursive: true });
      console.log(`‚úÖ Created directory: ${dossierDir}`);
    }

    // Check if key already exists
    if (fs.existsSync(trustedKeysPath)) {
      const content = fs.readFileSync(trustedKeysPath, 'utf8');
      if (content.includes(publicKey)) {
        console.log('‚ö†Ô∏è  This key already exists in trusted keys');
        console.log(`   Location: ${trustedKeysPath}\n`);
        process.exit(0);
      }
    }

    // Add key to file
    const entry = `${publicKey} ${identifier}\n`;
    fs.appendFileSync(trustedKeysPath, entry, 'utf8');

    console.log('‚úÖ Key added successfully');
    console.log(`   Identifier: ${identifier}`);
    console.log(`   Public Key: ${publicKey.substring(0, 60)}${publicKey.length > 60 ? '...' : ''}`);
    console.log(`   Location: ${trustedKeysPath}`);
    console.log('\nYou can now verify dossiers signed with this key.\n');

    process.exit(0);
  });

// ============================================================================
// Parse and execute
// ============================================================================
program.parse(process.argv);

// Show help if no command provided
if (!process.argv.slice(2).length) {
  program.outputHelp();
}
